Index: c/src/make/leaf.cfg
===================================================================
RCS file: /usr1/CVS/rtems/c/src/make/leaf.cfg,v
retrieving revision 1.11
diff -u -r1.11 leaf.cfg
--- c/src/make/leaf.cfg	15 Apr 2009 08:31:09 -0000	1.11
+++ c/src/make/leaf.cfg	21 Apr 2009 13:05:54 -0000
@@ -41,8 +41,9 @@
 # Create a RTEMS executable based on MANAGERS which was set in
 #  app's Makefile
 
-MANAGERS_NOT_WANTED=$(filter-out $(MANAGERS) \
-	$(MANAGERS_REQUIRED), $(MANAGER_LIST))
+## XXX Joel make conditional
+## MANAGERS_NOT_WANTED=$(filter-out $(MANAGERS) \
+## 	$(MANAGERS_REQUIRED), $(MANAGER_LIST))
 
 # Allow user to override link commands (to build a prom image, perhaps)
 ifndef LINKCMDS
@@ -55,14 +56,25 @@
 
 DOWNEXT=.ralf
 
+
+ifeq ($(ENABLE_COVERAGE),yes)
+COV_ARGS=-Wl,--undefined=rtems_task_create \
+         -Wl,--undefined=pthread_create \
+         -Wl,--undefined=end_of_profiling \
+         -Wl,--whole-archive -lrtems -lsapi \
+         -lscore -lposix -Wl,--no-whole-archive \
+         -lcsupport
+
+endif
+
 define bsp-link-c
 	$(LINK.c) $(CPU_CFLAGS) $(AM_CFLAGS) $(AM_LDFLAGS) \
-	    -o $(basename $@)$(EXEEXT) $(LINK_OBJS) $(LINK_LIBS)
+	    -o $(basename $@)$(EXEEXT) $(COV_ARGS) $(LINK_OBJS) $(LINK_LIBS)
 endef
 
 define bsp-link-cxx
 	$(LINK.cc) $(CPU_CFLAGS) $(AM_CFLAGS) $(AM_LDFLAGS) \
-	    -o $(basename $@)$(EXEEXT) $(LINK_OBJS) $(LINK_LIBS)
+	    -o $(basename $@)$(EXEEXT) $(COV_ARGS) $(LINK_OBJS) $(LINK_LIBS)
 endef
 
 define default-bsp-post-link
Index: c/src/make/target.cfg.in
===================================================================
RCS file: /usr1/CVS/rtems/c/src/make/target.cfg.in,v
retrieving revision 1.7
diff -u -r1.7 target.cfg.in
--- c/src/make/target.cfg.in	4 Aug 2007 05:45:16 -0000	1.7
+++ c/src/make/target.cfg.in	21 Apr 2009 13:05:54 -0000
@@ -55,6 +55,7 @@
 # Create a RTEMS executable based on MANAGERS which was set in
 #  app's Makefile
 
-MANAGERS_NOT_WANTED=$(filter-out $(MANAGERS) \
-	$(MANAGERS_REQUIRED), $(MANAGER_LIST))
+## XXX Joel make conditional
+## MANAGERS_NOT_WANTED=$(filter-out $(MANAGERS) \
+## 	$(MANAGERS_REQUIRED), $(MANAGER_LIST))
 
Index: cpukit/libcsupport/Makefile.am
===================================================================
RCS file: /usr1/CVS/rtems/cpukit/libcsupport/Makefile.am,v
retrieving revision 1.99
diff -u -r1.99 Makefile.am
--- cpukit/libcsupport/Makefile.am	5 Jan 2009 06:04:10 -0000	1.99
+++ cpukit/libcsupport/Makefile.am	21 Apr 2009 13:05:54 -0000
@@ -109,7 +109,7 @@
 BSD_LIBC_C_FILES = src/strlcpy.c src/strlcat.c
 
 libcsupport_a_SOURCES = src/gxx_wrappers.c src/getchark.c src/printk.c \
-    src/printk_plugin.c \
+    src/printk_plugin.c src/end_profile.c \
     $(BSD_LIBC_C_FILES) $(BASE_FS_C_FILES) $(MALLOC_C_FILES) \
     $(ERROR_C_FILES) $(ASSOCIATION_C_FILES)
 
Index: cpukit/libcsupport/src/end_profile.c
===================================================================
RCS file: cpukit/libcsupport/src/end_profile.c
diff -N cpukit/libcsupport/src/end_profile.c
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ cpukit/libcsupport/src/end_profile.c	21 Apr 2009 13:05:54 -0000
@@ -0,0 +1,5 @@
+
+/* special symbol to mark end of profiling */
+void end_of_profiling(void)
+{
+}
Index: cpukit/rtems/Makefile.am
===================================================================
RCS file: /usr1/CVS/rtems/cpukit/rtems/Makefile.am,v
retrieving revision 1.45
diff -u -r1.45 Makefile.am
--- cpukit/rtems/Makefile.am	17 Dec 2008 20:21:39 -0000	1.45
+++ cpukit/rtems/Makefile.am	21 Apr 2009 13:05:54 -0000
@@ -7,6 +7,7 @@
 
 AM_CPPFLAGS += -D__RTEMS_INSIDE__
 
+project_lib_LIBRARIES = librtems.a
 noinst_LIBRARIES = librtems.a
 librtems_a_CPPFLAGS = $(AM_CPPFLAGS)
 
Index: cpukit/rtems/preinstall.am
===================================================================
RCS file: /usr1/CVS/rtems/cpukit/rtems/preinstall.am,v
retrieving revision 1.11
diff -u -r1.11 preinstall.am
--- cpukit/rtems/preinstall.am	29 Jan 2008 21:52:20 -0000	1.11
+++ cpukit/rtems/preinstall.am	21 Apr 2009 13:05:54 -0000
@@ -8,16 +8,30 @@
 PREINSTALL_DIRS =
 DISTCLEANFILES = $(PREINSTALL_DIRS)
 
+all-local: $(TMPINSTALL_FILES)
+
+TMPINSTALL_FILES =
+CLEANFILES = $(TMPINSTALL_FILES)
+
 all-am: $(PREINSTALL_FILES)
 
 PREINSTALL_FILES =
-CLEANFILES = $(PREINSTALL_FILES)
+CLEANFILES += $(PREINSTALL_FILES)
+
+$(PROJECT_LIB)/$(dirstamp):
+	@$(MKDIR_P) $(PROJECT_LIB)
+	@: > $(PROJECT_LIB)/$(dirstamp)
+PREINSTALL_DIRS += $(PROJECT_LIB)/$(dirstamp)
 
 $(PROJECT_INCLUDE)/$(dirstamp):
 	@$(MKDIR_P) $(PROJECT_INCLUDE)
 	@: > $(PROJECT_INCLUDE)/$(dirstamp)
 PREINSTALL_DIRS += $(PROJECT_INCLUDE)/$(dirstamp)
 
+$(PROJECT_LIB)/librtems.a: librtems.a $(PROJECT_LIB)/$(dirstamp)
+	$(INSTALL_DATA) $< $(PROJECT_LIB)/librtems.a
+TMPINSTALL_FILES += $(PROJECT_LIB)/librtems.a
+
 $(PROJECT_INCLUDE)/rtems.h: include/rtems.h $(PROJECT_INCLUDE)/$(dirstamp)
 	$(INSTALL_DATA) $< $(PROJECT_INCLUDE)/rtems.h
 PREINSTALL_FILES += $(PROJECT_INCLUDE)/rtems.h
Index: cpukit/sapi/Makefile.am
===================================================================
RCS file: /usr1/CVS/rtems/cpukit/sapi/Makefile.am,v
retrieving revision 1.35
diff -u -r1.35 Makefile.am
--- cpukit/sapi/Makefile.am	15 Jul 2008 22:56:45 -0000	1.35
+++ cpukit/sapi/Makefile.am	21 Apr 2009 13:05:54 -0000
@@ -20,6 +20,7 @@
 ## src
 AM_CPPFLAGS += -D__RTEMS_INSIDE__
 
+project_lib_LIBRARIES = libsapi.a
 noinst_LIBRARIES = libsapi.a
 libsapi_a_SOURCES = src/debug.c src/extension.c src/extensioncreate.c \
     src/extensiondelete.c src/extensionident.c src/fatal.c src/exinit.c \
Index: cpukit/sapi/preinstall.am
===================================================================
RCS file: /usr1/CVS/rtems/cpukit/sapi/preinstall.am,v
retrieving revision 1.10
diff -u -r1.10 preinstall.am
--- cpukit/sapi/preinstall.am	3 Jul 2008 01:37:38 -0000	1.10
+++ cpukit/sapi/preinstall.am	21 Apr 2009 13:05:54 -0000
@@ -8,10 +8,20 @@
 PREINSTALL_DIRS =
 DISTCLEANFILES = $(PREINSTALL_DIRS)
 
+all-local: $(TMPINSTALL_FILES)
+
+TMPINSTALL_FILES =
+CLEANFILES = $(TMPINSTALL_FILES)
+
 all-am: $(PREINSTALL_FILES)
 
 PREINSTALL_FILES =
-CLEANFILES = $(PREINSTALL_FILES)
+CLEANFILES += $(PREINSTALL_FILES)
+
+$(PROJECT_LIB)/$(dirstamp):
+	@$(MKDIR_P) $(PROJECT_LIB)
+	@: > $(PROJECT_LIB)/$(dirstamp)
+PREINSTALL_DIRS += $(PROJECT_LIB)/$(dirstamp)
 
 $(PROJECT_INCLUDE)/rtems/$(dirstamp):
 	@$(MKDIR_P) $(PROJECT_INCLUDE)/rtems
@@ -62,3 +72,7 @@
 	$(INSTALL_DATA) $< $(PROJECT_INCLUDE)/rtems/extension.inl
 PREINSTALL_FILES += $(PROJECT_INCLUDE)/rtems/extension.inl
 
+$(PROJECT_LIB)/libsapi.a: libsapi.a $(PROJECT_LIB)/$(dirstamp)
+	$(INSTALL_DATA) $< $(PROJECT_LIB)/libsapi.a
+TMPINSTALL_FILES += $(PROJECT_LIB)/libsapi.a
+
Index: cpukit/score/Makefile.am
===================================================================
RCS file: /usr1/CVS/rtems/cpukit/score/Makefile.am,v
retrieving revision 1.66
diff -u -r1.66 Makefile.am
--- cpukit/score/Makefile.am	2 Mar 2009 18:10:34 -0000	1.66
+++ cpukit/score/Makefile.am	21 Apr 2009 13:05:54 -0000
@@ -66,6 +66,7 @@
 
 AM_CPPFLAGS += -D__RTEMS_INSIDE__
 
+project_lib_LIBRARIES = libscore.a
 noinst_LIBRARIES = libscore.a
 libscore_a_SOURCES =
 libscore_a_CPPFLAGS = $(AM_CPPFLAGS)
Index: cpukit/score/preinstall.am
===================================================================
RCS file: /usr1/CVS/rtems/cpukit/score/preinstall.am,v
retrieving revision 1.18
diff -u -r1.18 preinstall.am
--- cpukit/score/preinstall.am	9 Dec 2008 21:27:35 -0000	1.18
+++ cpukit/score/preinstall.am	21 Apr 2009 13:05:54 -0000
@@ -8,10 +8,20 @@
 PREINSTALL_DIRS =
 DISTCLEANFILES += $(PREINSTALL_DIRS)
 
+all-local: $(TMPINSTALL_FILES)
+
+TMPINSTALL_FILES =
+CLEANFILES = $(TMPINSTALL_FILES)
+
 all-am: $(PREINSTALL_FILES)
 
 PREINSTALL_FILES =
-CLEANFILES = $(PREINSTALL_FILES)
+CLEANFILES += $(PREINSTALL_FILES)
+
+$(PROJECT_LIB)/$(dirstamp):
+	@$(MKDIR_P) $(PROJECT_LIB)
+	@: > $(PROJECT_LIB)/$(dirstamp)
+PREINSTALL_DIRS += $(PROJECT_LIB)/$(dirstamp)
 
 $(PROJECT_INCLUDE)/rtems/$(dirstamp):
 	@$(MKDIR_P) $(PROJECT_INCLUDE)/rtems
@@ -285,3 +295,7 @@
 	$(INSTALL_DATA) $< $(PROJECT_INCLUDE)/rtems/score/threadmp.inl
 PREINSTALL_FILES += $(PROJECT_INCLUDE)/rtems/score/threadmp.inl
 endif
+$(PROJECT_LIB)/libscore.a: libscore.a $(PROJECT_LIB)/$(dirstamp)
+	$(INSTALL_DATA) $< $(PROJECT_LIB)/libscore.a
+TMPINSTALL_FILES += $(PROJECT_LIB)/libscore.a
+
Index: make/leaf.cfg
===================================================================
RCS file: /usr1/CVS/rtems/make/leaf.cfg,v
retrieving revision 1.24
diff -u -r1.24 leaf.cfg
--- make/leaf.cfg	15 Sep 2008 17:43:22 -0000	1.24
+++ make/leaf.cfg	21 Apr 2009 13:05:54 -0000
@@ -116,14 +116,23 @@
 
 DOWNEXT=.ralf
 
+ifeq ($(ENABLE_COVERAGE),yes)
+COV_ARGS=-Wl,--undefined=rtems_task_create \
+         -Wl,--undefined=pthread_create \
+         -Wl,--undefined=end_of_profiling \
+         -Wl,--whole-archive -lrtems -lsapi \
+         -lscore -lposix -Wl,--no-whole-archive \
+         -lcsupport
+endif
+
 define bsp-link-c
 	$(LINK.c) $(CPU_CFLAGS) $(AM_CFLAGS) $(AM_LDFLAGS) \
-	    -o $(basename $@).exe $(LINK_OBJS) $(LINK_LIBS)
+	    -o $(basename $@).exe $(COV_ARGS) $(LINK_OBJS) $(LINK_LIBS)
 endef
 
 define bsp-link-cxx
 	$(LINK.cc) $(CPU_CFLAGS) $(AM_CFLAGS) $(AM_LDFLAGS) \
-	    -o $(basename $@).exe $(LINK_OBJS) $(LINK_LIBS)
+	    -o $(basename $@).exe $(COV_ARGS) $(LINK_OBJS) $(LINK_LIBS)
 endef
 
 define default-bsp-post-link
Index: make/compilers/gcc-no_bsp.cfg
===================================================================
RCS file: /usr1/CVS/rtems/make/compilers/gcc-no_bsp.cfg,v
retrieving revision 1.14
diff -u -r1.14 gcc-no_bsp.cfg
--- make/compilers/gcc-no_bsp.cfg	18 Sep 2008 17:33:55 -0000	1.14
+++ make/compilers/gcc-no_bsp.cfg	21 Apr 2009 13:05:54 -0000
@@ -201,8 +201,9 @@
 
 # Create a RTEMS executable based on MANAGERS which was set in app's Makefile
 
-MANAGERS_NOT_WANTED=$(filter-out $(MANAGERS), $(MANAGER_LIST))
-MANAGERS_NOT_WANTED:=$(filter-out $(MANAGERS_REQUIRED), $(MANAGERS_NOT_WANTED))
+## XXX JOEL make conditional
+## MANAGERS_NOT_WANTED=$(filter-out $(MANAGERS), $(MANAGER_LIST))
+## MANAGERS_NOT_WANTED:=$(filter-out $(MANAGERS_REQUIRED), $(MANAGERS_NOT_WANTED))
 
 CONSTRUCTOR=
 
Index: make/custom/edb7312.cfg
===================================================================
RCS file: /usr1/CVS/rtems/make/custom/edb7312.cfg,v
retrieving revision 1.8
diff -u -r1.8 edb7312.cfg
--- make/custom/edb7312.cfg	6 Mar 2008 21:51:00 -0000	1.8
+++ make/custom/edb7312.cfg	21 Apr 2009 13:05:54 -0000
@@ -18,4 +18,6 @@
 CPU_CFLAGS = -mcpu=$(RTEMS_CPU_MODEL) -mstructure-size-boundary=8
 
 # optimize flag: typically -O2
-CFLAGS_OPTIMIZE_V = -O2 -g
+CFLAGS_OPTIMIZE_V = -Os -g
+
+ENABLE_COVERAGE=yes
Index: make/custom/erc32.cfg
===================================================================
RCS file: /usr1/CVS/rtems/make/custom/erc32.cfg,v
retrieving revision 1.37
diff -u -r1.37 erc32.cfg
--- make/custom/erc32.cfg	1 Oct 2008 13:19:51 -0000	1.37
+++ make/custom/erc32.cfg	21 Apr 2009 13:05:54 -0000
@@ -18,4 +18,6 @@
 CPU_CFLAGS = -mcpu=cypress
 
 # optimize flag: typically -O2
-CFLAGS_OPTIMIZE_V = -O2 -g
+CFLAGS_OPTIMIZE_V = -Os -g
+
+ENABLE_COVERAGE=yes
Index: make/custom/leon2.cfg
===================================================================
RCS file: /usr1/CVS/rtems/make/custom/leon2.cfg,v
retrieving revision 1.14
diff -u -r1.14 leon2.cfg
--- make/custom/leon2.cfg	6 Mar 2008 21:51:01 -0000	1.14
+++ make/custom/leon2.cfg	21 Apr 2009 13:05:54 -0000
@@ -16,4 +16,6 @@
 CPU_CFLAGS = -mcpu=cypress -msoft-float
 
 # optimize flag: typically -O2
-CFLAGS_OPTIMIZE_V = -O2 -g
+CFLAGS_OPTIMIZE_V = -Os -g
+
+ENABLE_COVERAGE=yes
Index: make/custom/leon3.cfg
===================================================================
RCS file: /usr1/CVS/rtems/make/custom/leon3.cfg,v
retrieving revision 1.9
diff -u -r1.9 leon3.cfg
--- make/custom/leon3.cfg	6 Mar 2008 21:51:01 -0000	1.9
+++ make/custom/leon3.cfg	21 Apr 2009 13:05:54 -0000
@@ -18,4 +18,6 @@
 CPU_CFLAGS = -mcpu=cypress -msoft-float
 
 # optimize flag: typically -O2
-CFLAGS_OPTIMIZE_V = -O2 -g
+CFLAGS_OPTIMIZE_V = -Os -g
+
+ENABLE_COVERAGE=yes
Index: make/custom/rtl22xx.cfg
===================================================================
RCS file: /usr1/CVS/rtems/make/custom/rtl22xx.cfg,v
retrieving revision 1.5
diff -u -r1.5 rtl22xx.cfg
--- make/custom/rtl22xx.cfg	6 Mar 2008 21:51:01 -0000	1.5
+++ make/custom/rtl22xx.cfg	21 Apr 2009 13:05:54 -0000
@@ -22,3 +22,5 @@
 # NOTE2: some level of -O may be actually required by inline assembler (at least
 # -O2 so far.
 CFLAGS_OPTIMIZE_V = -Os -g -DNDEBUG
+
+ENABLE_COVERAGE=yes
